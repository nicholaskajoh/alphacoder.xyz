<!DOCTYPE html>
<html><head>
<title>Deploy microservices on Kubernetes</title>




<meta charset="utf-8">
<meta name="X-UA-Compatible" content="IE=edge">
<meta name="google-site-verification" content="">
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
<meta content="telephone=no" name="format-detection">
<meta name="description" content="">
<meta name="renderer" content="webkit">
<meta name="theme-color" content="#ffffff">












<script defer data-domain="alphacoder.xyz" src="https://analytics.terna.io/js/plausible.js"></script>


<link type="text/css" rel="stylesheet" href="/vendor/css/bootstrap.min.css">


  




<link rel="icon" href="https://alphacoder.xyz/images/alpha-coder-logo-v1-small.png">



<link rel="stylesheet" href="https://alphacoder.xyz/scss/journal.min.e3bbe8a4e9def42361d46a08558b2ceeb666c944d881cbcfa75a3435be6afa74.css" integrity="sha256-47vopOne9CNh1GoIVYss7rZmyUTYgcvPp1o0Nb5q&#43;nQ=" media="screen">



<link rel="stylesheet" href="https://alphacoder.xyz/scss/dark-mode.min.16749f4d04ce998e04ecf1c45f01d051b413e9693378f8834e15973538e1d735.css" integrity="sha256-FnSfTQTOmY4E7PHEXwHQUbQT6WkzePiDThWXNTjh1zU=" media="screen">


<script src="/vendor/js/loadCSS.js"></script>
<script>
  loadCSS("https://fonts.googleapis.com/css?family=Lora|Montserrat|Fira+Mono|Noto+Serif+SC|Material+Icons|Exo+2");
</script>






  <script src="/js/toc.js"></script>







<script src="https://cdn.jsdelivr.net/npm/vue-disqus@3/dist/vue-disqus.js"></script>








</head>
<body>
    	<div id="app"><div id="sideContainer" class="side-container">
    
    <a class="a-block nav-head false" href="https://alphacoder.xyz/">
    
        <div class="nav-title">
            Alpha Coder
        </div>
        
    </a>

    <div class="nav-link-list">
        
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="/blog/">
                Blog
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://codereviewclub.com">
                Code Review Club
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://www.youtube.com/channel/UC1vg_0J9BGfahmc7flbiwJw">
                Videos
            </a>
            
        
            
            
            
            
            
            <a class="a-block nav-link-item false" href="https://tinyletter.com/nicholaskajoh">
                Newsletter
            </a>
            
        
    </div>

    

    <div class="nav-footer">
        
<a href="https://twitter.com/AlphaCoderXYZ">
    Twitter
</a>
<br>

<a href="mailto:support@alphacoder.xyz">
    Email
</a>
<br>

<a href="/blog/index.xml">
    RSS
</a>
<br>


        &copy;
    
    Copyright 2017 to ∞. Nicholas Kajoh. All rights reserved.
    

    </div>
    
</div><div id="extraContainer" class="extra-container">
    
    
    <div class="toc animated-visibility" :class="{ invisible: scrollY <= 140 }">


	<div class="toc-content">
	
		
		
		
		<center>- OUTLINE -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#microservice-architecture" onclick="onNavClick(`#microservice-architecture-nav`)" id="microservice-architecture-nav">
									Microservice architecture
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#common-kubernetes-terms" onclick="onNavClick(`#common-kubernetes-terms-nav`)" id="common-kubernetes-terms-nav">
									Common Kubernetes terms
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#yoloo" onclick="onNavClick(`#yoloo-nav`)" id="yoloo-nav">
									Yoloo
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#google-cloud-platform-gcp" onclick="onNavClick(`#google-cloud-platform-gcp-nav`)" id="google-cloud-platform-gcp-nav">
									Google Cloud Platform (GCP)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#google-container-registry-gcr" onclick="onNavClick(`#google-container-registry-gcr-nav`)" id="google-container-registry-gcr-nav">
									Google Container Registry (GCR)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#deployments" onclick="onNavClick(`#deployments-nav`)" id="deployments-nav">
									Deployments
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#services" onclick="onNavClick(`#services-nav`)" id="services-nav">
									Services
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#cloudinary-and-redis" onclick="onNavClick(`#cloudinary-and-redis-nav`)" id="cloudinary-and-redis-nav">
									Cloudinary and Redis
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#kubectl" onclick="onNavClick(`#kubectl-nav`)" id="kubectl-nav">
									kubectl
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
    
    <div class="pagination">
        <a id="globalBackToTop" class="pagination-action animated-visibility" href="#top" :class="{ invisible: scrollY == 0 }">
            <i class="material-icons pagination-action-icon">
                keyboard_arrow_up
            </i>
        </a>
        
        <a type="button" class="pagination-action" id="darkModeToggleButton">
            <span class="material-icons pagination-action-icon" id="darkModeToggleIcon">
                dark_mode
            </span>
        </a>
        
        
    </div>
</div>
<div class="single-column-drawer-container" id="drawer"
     v-bind:class="{ 'single-column-drawer-container-active': isDrawerOpen }">
    <div class="drawer-content">
        <div class="drawer-menu">
            
            
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="/blog/">
                    Blog
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://codereviewclub.com">
                    Code Review Club
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://www.youtube.com/channel/UC1vg_0J9BGfahmc7flbiwJw">
                    Videos
                </a>
                
            
                
                
                
                
                
                <a class="a-block drawer-menu-item false" href="https://tinyletter.com/nicholaskajoh">
                    Newsletter
                </a>
                
            
            
            <div class="toc">


	<div class="toc-content">
	
		
		
		
		<center>- OUTLINE -</center>
		
		
		<ul>
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#microservice-architecture" onclick="onNavClick(`#microservice-architecture-nav`)" id="microservice-architecture-nav">
									Microservice architecture
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#common-kubernetes-terms" onclick="onNavClick(`#common-kubernetes-terms-nav`)" id="common-kubernetes-terms-nav">
									Common Kubernetes terms
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#yoloo" onclick="onNavClick(`#yoloo-nav`)" id="yoloo-nav">
									Yoloo
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#google-cloud-platform-gcp" onclick="onNavClick(`#google-cloud-platform-gcp-nav`)" id="google-cloud-platform-gcp-nav">
									Google Cloud Platform (GCP)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#google-container-registry-gcr" onclick="onNavClick(`#google-container-registry-gcr-nav`)" id="google-container-registry-gcr-nav">
									Google Container Registry (GCR)
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#deployments" onclick="onNavClick(`#deployments-nav`)" id="deployments-nav">
									Deployments
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#services" onclick="onNavClick(`#services-nav`)" id="services-nav">
									Services
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#cloudinary-and-redis" onclick="onNavClick(`#cloudinary-and-redis-nav`)" id="cloudinary-and-redis-nav">
									Cloudinary and Redis
								</a>
							</li>
						
						
					
				
			
				
				
					
						
						
						
						
						
							<li>
								<a href="#kubectl" onclick="onNavClick(`#kubectl-nav`)" id="kubectl-nav">
									kubectl
								</a>
							</li>
						
						
					
				
			
		</ul>
	</div>

</div>
            
        </div>
    </div>
</div>
<transition name="fade">
    <div id="drawer-mask" v-bind:class="{ 'single-column-drawer-mask': mounted }" v-if="isDrawerOpen" v-on:click="toggleDrawer"></div>
</transition>
<nav id="navBar" class="navbar sticky-top navbar-light single-column-nav-container">
    <div id="navBackground" class="nav-background"></div>
    <div class="container container-narrow nav-content">
        <button id="nav_dropdown_btn" class="nav-dropdown-toggle" type="button" v-on:click="toggleDrawer">
            <i class="material-icons">
                menu
            </i>
        </button>
        <a id="navTitle" class="navbar-brand" href="https://alphacoder.xyz/">
            Alpha Coder
        </a>
        
        <button type="button" class="nav-darkmode-toggle" id="darkModeToggleButton2">
            <i class="material-icons" id="darkModeToggleIcon2">
                dark_mode
            </i>
        </button>
        
    </div>
</nav>
<div class="single-column-header-container" id="pageHead"
     v-bind:style="{ transform: 'translateZ(0px) translateY('+.3*scrollY+'px)', opacity: 1-navOpacity }">
    <a href="https://alphacoder.xyz/">
        <div class="single-column-header-title">Alpha Coder</div>
        

    </a>
</div>

            <div id="content">
                <div id="streamContainer" class="stream-container">

    <div class="post-list-container post-list-container-shadow">
        <div class="post">
            
            
            

            <div class="post-head-wrapper-text-only"
                
            >
                <div class="post-title" v-pre>
                    Deploy microservices on Kubernetes
                    
                    <div class="post-meta">
                        
                        <time itemprop="datePublished">
                            2019-02-01
                        </time>
                        

                        

                        
                            <i class="material-icons" style="">label</i>
                            
                                <a href="/tag/kubernetes">Kubernetes</a>
                                &nbsp;
                            
                                <a href="/tag/microservices">Microservices</a>
                                &nbsp;
                            
                                <a href="/tag/docker">Docker</a>
                                &nbsp;
                            
                        
                        
                    </div>
                </div>
            </div>
            
            <div class="post-body-wrapper">
                
                <div class="post-body" v-pre>
                
                    <p>Kubernetes (AKA k8s) has gained <a href="https://kubernetes.io/case-studies/">widespread adoption</a> in recent years as a platform for microservices due to its ability to seamlessly automate app deployment at scale. <a href="http://pinterest.com">Pinterest</a> uses <a href="https://www.cncf.io/case-study-pinterest/">a suite of over 1000 microservices</a> to power their &ldquo;discovery engine&rdquo;. Imagine having to configure and manage servers to run these services manually. It&rsquo;s an Engineer&rsquo;s nightmare to say the least.</p>
<p>Kubernetes bills itself as &ldquo;a portable, extensible open-source platform for managing containerized workloads and services&rdquo;. In simple terms, Kubernetes helps to automate the deployment and management of containerized applications. This means we can package an app (code, dependencies and config) <a href="https://www.docker.com/resources/what-container">in a container</a> and hand it over to Kubernetes to deploy and scale without worrying about our infrastructure. Under the hood, Kubernetes decides where to run what, monitors the systems and fixes things if something goes wrong.</p>
<h1 id="microservice-architecture">Microservice architecture</h1>
<p>I particularly like <a href="https://martinfowler.com/microservices/">James Lewis&rsquo; and Martin Fowler&rsquo;s definition of microservices</a> as it points out why Kubernetes is such a good solution for the architecture. &ldquo;The microservice architectural style is an approach to developing a single application as a suite of small services, each running in its own process and communicating with lightweight mechanisms, often an HTTP resource API. These services are built around business capabilities and independently deployable by <strong>fully automated deployment machinery</strong>. There is a bare minimum of centralized management of these services, which may be written in different programming languages and use different data storage technologies&rdquo;. Kubernetes is in fact a &ldquo;fully automated deployment machine&rdquo; that provides a powerful abstraction layer atop server infrastructure.</p>
<h1 id="common-kubernetes-terms">Common Kubernetes terms</h1>
<p>Below are some common terms associated with Kubernetes.</p>
<ul>
<li><strong>Node:</strong> A node is a single machine in a Kubernetes cluster. It can be a virtual or physical machine.</li>
<li><strong>Cluster:</strong> A cluster consists of at least one master machine and multiple worker machines called nodes.</li>
<li><strong>Pod:</strong> A pod is the basic unit of computing in Kubernetes. Containers are not run directly. Instead, they are wrapped in a pod.</li>
<li><strong>Deployment:</strong> A deployment is used to manage a pod or set of pods. Pods are typically not created or managed directly. Deployments can automatically spin up any number of pods. If a pod dies, a deployment can automatically recreate it as well.</li>
<li><strong>Service:</strong> Pods are mortal. Consumers should however not be burdened with figuring out what pods are available and how to access them. Services keep track of all available pods of a certain type and provide a way to access them.</li>
</ul>
<h1 id="yoloo">Yoloo</h1>
<p>In this tutorial, we&rsquo;ll be deploying a simple microservices app called Yoloo on <a href="https://cloud.google.com/kubernetes-engine/">Google Kubernetes Engine (GKE)</a>, a managed Kubernetes service on Google Cloud Platform. Yoloo uses a pre-trained YOLO (<a href="https://www.youtube.com/watch?v=Cgxsv1riJhI">You Only Look Once</a>) model to detect common objects such as bottles and humans in an image. It comprises two microservices, <em>detector</em> and <em>viewer</em>. The detector service is a Python/Flask app which takes an image and passes it through the YOLO model to identify the objects in it. The viewer service is a PHP app that acts as a front-end by providing a User Interface for uploading and viewing the images. The app is built to use two external, managed services: Cloudinary for image hosting and Redis for data storage. The source code is available <a href="https://github.com/nicholaskajoh/microservices">on my GitHub</a>.</p>
<p><a href="https://github.com/nicholaskajoh/microservices/archive/master.zip">Download</a> or clone the project with Git: <code>git clone https://github.com/nicholaskajoh/microservices.git</code>.</p>
<p>Detector service Dockerfile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> python:3.6-stretch</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 8080</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> mkdir /www<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /www</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> requirements.txt /www/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> pip install -r requirements.txt<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENV</span> PYTHONUNBUFFERED <span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /www/<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> gunicorn --bind 0.0.0.0:8080 wsgi<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Viewer service Dockerfile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> php:7.2-apache</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . /var/www/html/<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>Download the YOLO weights in the detector directory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd detector/ <span style="color:#f92672">&amp;&amp;</span> wget https://pjreddie.com/media/files/yolov3.weights
</span></span></code></pre></div><p>Change directory to <code>viewer/</code> and install the PHP dependencies. You need to have <a href="https://www.apachefriends.org/index.html">PHP</a> and <a href="https://getcomposer.org">Composer</a> installed.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>composer install
</span></span></code></pre></div><h1 id="google-cloud-platform-gcp">Google Cloud Platform (GCP)</h1>
<p>Visit <a href="https://console.cloud.google.com/home/dashboard">https://console.cloud.google.com/home/dashboard</a> and create a new project. You need to have a Google account.</p>
<p><strong>NB:</strong> Google offers <a href="https://cloud.google.com/free/">a tier with $300 free credit</a> (for 1 year) to use any GCP product you want.</p>
<p><img src="/images/ms-k8s/new-project-gcp.jpg" alt="">
<em>Create a new project on Google Cloud Platform</em></p>
<p><strong>NB:</strong> Make sure you <a href="https://cloud.google.com/billing/docs/how-to/modify-project#enable_billing_for_a_new_project">enable billing</a> for your project.</p>
<p>Go to the <a href="https://console.cloud.google.com/kubernetes">Kubernetes section</a> of GCP and create a new <em>standard</em> cluster. GKE uses VM instances on Google Compute Engine as nodes in the cluster.</p>
<p><img src="/images/ms-k8s/new-cluster-gke.jpg" alt="">
<em>Create a new k8s cluster</em></p>
<h1 id="google-container-registry-gcr">Google Container Registry (GCR)</h1>
<p>Kubernetes uses container images to launch pods. Images need to be stored in a registry where they can be pulled from. GCP provides a registry, the <a href="https://cloud.google.com/container-registry/">Google Container Registry</a>, which can be used to store Docker images. Let&rsquo;s build the images for the detector and viewer services and push them to GCR.</p>
<ul>
<li>Install <a href="https://cloud.google.com/sdk/install">Google Cloud SDK</a> for your OS.</li>
<li>Login: <code>gcloud auth login</code>.</li>
<li>Configure docker to use the <code>gcloud</code> CLI as a credential helper: <code>gcloud auth configure-docker</code>. You only need to do this once.</li>
<li>Build the docker images for the microservices: <code>docker build -t detector-svc detector/</code> and <code>docker build -t viewer-svc viewer/</code>.</li>
<li>Tag the images with their registry names: <code>docker tag detector-svc gcr.io/{PROJECT_ID}/detector-svc</code> and <code>docker tag viewer-svc gcr.io/{PROJECT_ID}/viewer-svc</code>. <code>PROJECT_ID</code> is your GCP console project ID.</li>
<li>Push the docker images to GCR: <code>docker push gcr.io/{PROJECT_ID}/detector-svc</code> and <code>docker push gcr.io/{PROJECT_ID}/viewer-svc</code>.</li>
</ul>
<h1 id="deployments">Deployments</h1>
<p>The detector and viewer services contain deployment files, <code>detector-deployment.yaml</code> and <code>viewer-deployment.yaml</code> respectively, which tell k8s what workloads we want to run.</p>
<p>Detector service deployment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">detector-svc-deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">RollingUpdate</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">rollingUpdate</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxUnavailable</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">maxSurge</span>: <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">detector-svc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gcr.io/{PROJECT_ID}/detector-svc</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">detector-svc</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">envFrom</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">secretRef</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">detector-svc-secrets</span>
</span></span></code></pre></div><p>In this deployment, we want to run 3 copies (<code>replicas: 3</code>) of the detector service (<code>- image: gcr.io/{PROJECT_ID}/detector-svc</code>) for availability and scalability. We label the pods (<code>app: detector-svc</code>) so that they can easily be referenced as a group. We alse choose rolling updates (<code>type: RollingUpdate</code>) as our redeployment strategy. Rolling update means we can update the app without experiencing any downtime. In other words, k8s gradually replaces pods in the deployment so that the application is always available to consumers or clients even when an update is taking place.</p>
<p>Viewer service deployment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">extensions/v1beta1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">viewer-svc-deployment</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">replicas</span>: <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">minReadySeconds</span>: <span style="color:#ae81ff">15</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">strategy</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">type</span>: <span style="color:#ae81ff">Recreate</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">template</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">app</span>: <span style="color:#ae81ff">viewer-svc</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">containers</span>:
</span></span><span style="display:flex;"><span>        - <span style="color:#f92672">image</span>: <span style="color:#ae81ff">gcr.io/{PROJECT_ID}/viewer-svc</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">imagePullPolicy</span>: <span style="color:#ae81ff">Always</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">name</span>: <span style="color:#ae81ff">viewer-svc</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">containerPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">envFrom</span>:
</span></span><span style="display:flex;"><span>            - <span style="color:#f92672">secretRef</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">viewer-svc-secrets</span>
</span></span></code></pre></div><p>We choose a different redeployment strategy (<code>type: Recreate</code>) in the viewer service. This strategy destroys existing pods and recreates them with the updated image. Also, we&rsquo;re going with 2 replicas here.</p>
<p>Notice <code>envFrom</code> under <code>containers</code> in both deployments? We&rsquo;ll be loading our environment variables from a k8s Secret which we&rsquo;ll create soon.</p>
<h1 id="services">Services</h1>
<p>The k8s services (not to be confused with microservices) in detector and viewer, <code>detector-service.yaml</code> and <code>viewer-service.yaml</code>, share traffic among a set of replicas and provide an interface for other applications to access them. The detector service uses the ClusterIP k8s service which exposes the app on a cluster-internal IP. This means detector is only reachable from within the cluster. The viewer service uses the LoadBalancer service which exposes it externally to the outside world.</p>
<p>Detector k8s service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">detector-service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">ClusterIP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">8080</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">detector-svc</span>
</span></span></code></pre></div><p>Viewer k8s service.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">viewer-service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">LoadBalancer</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">protocol</span>: <span style="color:#ae81ff">TCP</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">app</span>: <span style="color:#ae81ff">viewer-svc</span>
</span></span></code></pre></div><p><strong>NB:</strong> we use the labels (<code>app: detector-svc</code> and <code>app: viewer-svc</code>) to select the group of pods created by the detector and viewer deployments, and make both services available on port 80.</p>
<h1 id="cloudinary-and-redis">Cloudinary and Redis</h1>
<p>As mentioned earlier, Yoloo depends on Cloudinary and Redis. Cloudinary is a cloud-based image/video hosting service and Redis is an in-memory key-value database.</p>
<p>Create an account <a href="https://cloudinary.com">on Cloudinary</a> and <a href="https://redislabs.com">on Redis Labs</a> (a free managed Redis hosting service).</p>
<p><img src="/images/ms-k8s/cloudinary-console.jpg" alt="">
<em>Cloudinary console</em></p>
<p><img src="/images/ms-k8s/redislabs-config.jpg" alt="">
<em>Redis Labs configuration</em></p>
<p>Create <em>.env</em> files from the example env files in both services (<em>.env.example</em>) and populate them with your Cloudinary and Redis credentials.</p>
<p>Detector service .env</p>
<pre tabindex="0"><code>FLASK_APP=detector.py
FLASK_ENV=production
CLOUDINARY_CLOUD_NAME=somethingawesome
CLOUDINARY_API_KEY=0123456789876543210
CLOUDINARY_API_SECRET=formyappseyesonly
</code></pre><p>Viewer service .env</p>
<pre tabindex="0"><code>CLOUDINARY_CLOUD_NAME=somethingawesome
CLOUDINARY_API_KEY=0123456789876543210
CLOUDINARY_API_SECRET=formyappseyesonly
DETECTOR_SVC_URL=http://detector-service
REDIS_URL=redis://:password@127.0.0.1:6379
</code></pre><p>Notice the url in <code>DETECTOR_SVC_URL</code>? Kubernetes creates DNS records within the cluster, mapping service names to their IP addresses. So we can use <code>http://detector-service</code> and not have to worry about what IP a service actually uses.</p>
<h1 id="kubectl">kubectl</h1>
<p>kubectl is a CLI tool for running commands against Kubernetes clusters. To get Kubernetes to run our microservices, we need to apply our deployments and services on the cluster. Outlined below are the steps involved.</p>
<p>Install <code>kubectl</code> CLI <a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/">for your OS</a>.</p>
<p>Set your Yoloo GCP project as default on the <code>gcloud</code> CLI.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud config set project <span style="color:#f92672">{</span>PROJECT_ID<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Set the default compute zone or region of your cluster. You can find this in the cluster details page on your GCP dashboard.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud config set compute/zone <span style="color:#f92672">{</span>COMPUTE_ZONE<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>or</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud config set compute/region <span style="color:#f92672">{</span>COMPUTE_REGION<span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Generate a <code>kubeconfig</code> entry to run <code>kubectl</code> commands against a your GCP cluster.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>gcloud container clusters get-credentials <span style="color:#f92672">{</span>CLUSTER_NAME<span style="color:#f92672">}</span>    
</span></span></code></pre></div><p><strong>NB:</strong> if you use minikube, you can use the following command to switch back to your local cluster.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl config use-context minikube
</span></span></code></pre></div><p>Create k8s Secrets from the .env files in both services.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create secret generic detector-svc-secrets --from-env-file<span style="color:#f92672">=</span>detector/.env
</span></span><span style="display:flex;"><span>kubectl create secret generic viewer-svc-secrets --from-env-file<span style="color:#f92672">=</span>viewer/.env
</span></span></code></pre></div><p>You can use the following commands to update the secrets.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl create secret generic detector-svc-secrets --from-env-file<span style="color:#f92672">=</span>detector/.env --dry-run -o yaml | kubectl apply -f -
</span></span><span style="display:flex;"><span>kubectl create secret generic viewer-svc-secrets --from-env-file<span style="color:#f92672">=</span>viewer/.env --dry-run -o yaml | kubectl apply -f -
</span></span></code></pre></div><p>Visit your GKE cluster dashboard on GCP and check the <em>Configuration</em> section. You should see the detector and viewer service secrets.</p>
<p><img src="/images/ms-k8s/gke-config.jpg" alt="">
<em>GKE cluster Config showing detector and viewer service secrets</em></p>
<p><strong>NB:</strong> If you want to view the secrets on your k8s cluster (e.g when debugging), you can install the <code>jq</code> utility (<a href="https://stedolan.github.io/jq/">https://stedolan.github.io/jq/</a>) and run the following where <code>my-secrets</code> is the name of your k8s secret.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get secret my-secrets -o json | jq <span style="color:#e6db74">&#39;.data | map_values(@base64d)&#39;</span>
</span></span></code></pre></div><p>Create the deployments.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f detector/detector-deployment.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f viewer/viewer-deployment.yaml
</span></span></code></pre></div><p>Check the <em>Workloads</em> section of the dashboard. You should see the detector and viewer service deployments.</p>
<p><img src="/images/ms-k8s/gke-workloads.jpg" alt="">
<em>GKE cluster Workloads showing the microservice deployments</em></p>
<p>Create the services.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply -f detector/detector-service.yaml
</span></span><span style="display:flex;"><span>kubectl apply -f viewer/viewer-service.yaml
</span></span></code></pre></div><p>The detector and viewer k8s services can be found in the <em>Services</em> section of the dashboard.</p>
<p><img src="/images/ms-k8s/gke-services.jpg" alt="">
<em>GKE cluster Services showing the k8s services for Yoloo</em></p>
<p>To visit the application, go to the viewer service page on the dashboard and locate the <em>External endpoints</em> IP address.</p>
<p><img src="/images/ms-k8s/viewer-svc-external-ip.jpg" alt="">
<em>Viewer service external IP address</em></p>
<hr>
<p><img src="/images/ms-k8s/yoloo-app-ui.jpg" alt="">
<em>UI of the Yoloo app</em></p>
<p><img src="/images/ms-k8s/yoloo-sample-output.jpg" alt="">
<em>Sample output image from Yoloo</em></p>

                    
                    <HR width="100%" id="EOF">
		    <p style="color:#777;">Last modified on 2019-06-09</p>
                    
                </div>
            </div>
            
            
            <nav class="post-pagination">

                
                <a class="newer-posts" href="https://alphacoder.xyz/dealing-with-code-debt/">
			Next<br>Dealing with code debt
                </a>
                
                
                
                <a class="older-posts" href="https://alphacoder.xyz/hello-hugo/">
			Previous<br>Hello Hugo!
                </a>
                
            </nav>
            <div class="post-comment-wrapper">
                
<div id="disqus_thread"></div>
<script>
    

    var disqus_config = function () {
        
        this.page.url = 'https:\/\/alphacoder.xyz\/deploy-microservices-on-kubernetes\/';  
        
        
        this.page.identifier = 'https:\/\/alphacoder.xyz\/deploy-microservices-on-kubernetes\/'; 
    };
    (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://alphacoderxyz.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript> Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow"> comments powered by Disqus.  </a> </noscript>











            </div>
        </div>
    </div>


                    </div>
            </div><div id="single-column-footer">&copy;
    
    Copyright 2017 to ∞. Nicholas Kajoh. All rights reserved.
    
</div>
            </div>
    
    <script src="/js/journal.js"></script>
    </body>
</html>
