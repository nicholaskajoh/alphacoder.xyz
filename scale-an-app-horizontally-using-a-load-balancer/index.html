<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>How to scale an app horizontally using a load balancer | Alpha Coder</title>

    <style>body{margin:40px auto;max-width:650px;line-height:1.6;font-size:18px;color:#444;padding:0 10px}h1,h2,h3{line-height:1.2}div.header h1{padding-top:0;padding-bottom:8px;margin-bottom:24px;font-size:18px;font-weight:400;border-bottom:1px solid}.header-menu{float:right}ul.pagination{list-style-type:none;text-align:center;padding:0}ul.pagination>li{padding:0 8px;display:inline-block}div.footer{border-top:1px solid;text-align:center}</style>
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-82728104-5', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


    
</head>

<body>
<div class="header">
    <h1>
        <a href="/">Alpha Coder</a>
        <div class="header-menu">
            <a href="/blog/">Blog</a>
            <a href="/courses/">Courses</a>
            <a href="http://bit.ly/nksnewsletter">Newsletter</a>
        </div>
    </h1>
</div>
<div id="content">

<header>
    <h1>How to scale an app horizontally using a load balancer</h1>
    

<div class="post-meta">
    Date &#x5b;
    <time datetime="2018-06-13">Jun 13, 2018</time>
    &#x5d;
</div>
</header>
<article>
    

<p>As your app grows (by getting more traffic, users, data etc), the need to increase its capacity or scale arises.</p>

<p>One way to scale is by optimizing your code. That may involve removing unnecessary code, using better algorithms or even using a faster programming language. While itâ€™s important to optimize the code in your app, thereâ€™s only so much the machine in which your app runs can do. The next logical step is to increase your server capacity.</p>

<p>There are mainly two ways to go about itâ€Šâ€”â€Šjuice up a single server or run your app on multiple servers.</p>

<p>The former is called <strong>vertical scaling</strong> and involves adding more memory, compute and/or storage to your server. This is very easy to accomplish if you run your app on a PaaS or IaaS platform. However, thereâ€™s only so much RAM/CPU/SSD etc you can get on one machine. Also, running high-end hardware is usually very expensive.</p>

<p>The latter approach is called <strong>horizontal scaling</strong>. It involves running your application on multiple servers and sharing traffic/load among them. Using this approach has some advantages. For one, you can scale infinitely. You just add more servers. Also, your app becomes <em>highly available</em> because if one server crashes/goes offline, you have other servers to handle incoming requests and/or other workloads.</p>

<p>Horizontal scaling works by placing a <strong>load balancer</strong> in front of your app servers. A load balancer is also a server. Its primary job is to distribute traffic among other servers.</p>

<p><img src="https://cdn-images-1.medium.com/max/800/1*YdLgSOulNgyYgdwc8Xh9Iw.png" alt="" /></p>

<p>Horizontal scaling (A, B, C and D represent your appÂ servers)</p>

<p>Most cloud providers have one-click-setup load balancers you can use if you run your app in their infrastructure. You may also choose to create your own load balancer using open source software like Nginx, HAProxy, Traefik etc.</p>

<p>In this tutorial, weâ€™re going to scale an app horizontally on DigitalOcean using their cloud load balancer. Letâ€™s do this!</p>

<h2 id="the-hits-app">The hits app</h2>

<p>The app weâ€™ll be scaling in this tutorial is called <strong><em>hits</em></strong>. Itâ€™s a simple Flask (Python) app that displays page hits. It counts every page load as a hit, and stores and caches the count in a PostgreSQL and Redis database respectively.</p>

<p><em>hits</em> source code: <a href="https://github.com/nicholaskajoh/hits"><strong>https://github.com/nicholaskajoh/hits</strong></a>.</p>

<p>The <em>hits</em> app is containerized using Docker for easy development and deployment. Knowledge of Python/Flask or Docker is not required to follow through in this tutorial. There are simple instructions provided in the README of the source code to run the app both locally and online.</p>

<h2 id="digitalocean">DigitalOcean</h2>

<p>DigitalOcean is a popular cloud computing platform loved for itâ€™s simplicity and pocket-friendly pricing. Weâ€™ll be using their VMs/servers (which they call Droplets) to run the <em>hits</em> app.</p>

<p>Youâ€™ll need to create an account on <a href="https://m.do.co/c/e38dd092b1ad">digitalocean.com</a> to get started. Droplets start at $5 per month but coupons abound. You can use my referral link and get $10 free: <a href="https://m.do.co/c/e38dd092b1ad">https://m.do.co/c/e38dd092b1ad</a>. More coupons here: <a href="https://gist.github.com/dexbyte/fb13e994ad180ce86c654cae1ce7d14f">https://gist.github.com/dexbyte/fb13e994ad180ce86c654cae1ce7d14f</a>.</p>

<h2 id="droplets">Droplets</h2>

<p>Once youâ€™ve signed up, verified your account and redeemed/purchased credits, head over to <a href="https://cloud.digitalocean.com">https://cloud.digitalocean.com</a> and create a new droplet.</p>

<p><img src="https://cdn-images-1.medium.com/max/1000/1*SAvbqvGB12X0zymRCEbWMw.jpeg" alt="" /></p>

<p>My droplets are already upÂ ðŸ˜‰</p>

<p>You can choose the configs you want if you know your way around provisioning servers. If you donâ€™t, you may use the options shown in the screenshot below.</p>

<p><img src="https://cdn-images-1.medium.com/max/800/1*CyGtHD4hAIVZwZts5kI00A.jpeg" alt="" /></p>

<p>Create aÂ droplet</p>

<p>When your servers are up, youâ€™ll need to connect to them via SSH. Itâ€™s advisable to generate an SSH key for your computer (<a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-1604">https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys-on-ubuntu-1604</a>). Alternatively, you can use username and password to login to your droplets.</p>

<h2 id="setup">Setup</h2>

<p>Here are the steps (in summary) to setup <em>hits</em> on your droplet. You may <a href="https://hackernoon.com/a-gentle-introduction-to-tmux-8d784c404340">use <em>tmux</em></a> to perform the steps simultaneously on multiple servers.</p>

<ul>
<li>SSH into the droplet as root (user) using <code>ssh root@DROPLET_IP_ADDRESS</code>. Windows users may need an SSH client like PuTTY (<a href="https://www.howtogeek.com/311287/how-to-connect-to-an-ssh-server-from-windows-macos-or-linux/">https://www.howtogeek.com/311287/how-to-connect-to-an-ssh-server-from-windows-macos-or-linux/</a>).</li>
<li>Create a non-root user and login as that user (<a href="https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/initial-server-setup-with-ubuntu-16-04</a>)</li>
<li>Clone the <em>hits</em> repo into your server with <code>git clone [https://github.com/nicholaskajoh/hits.git](https://github.com/nicholaskajoh/hits.git.)</code><a href="https://github.com/nicholaskajoh/hits.git.">.</a> DigitalOcean droplets come with Git pre-installed so you donâ€™t need to install it. PS: You can clone the project anywhere you like. I cloned mine in /var/www. You can do the same with this command: <code>sudo mkdir /var/www &amp;&amp; sudo chown ${USER}: /var/www &amp;&amp; sudo chmod u+w /var/www &amp;&amp; cd /var/www &amp;&amp; git clone [https://github.com/nicholaskajoh/hits.git](https://github.com/nicholaskajoh/hits.git.)</code>.</li>
<li>Create a <em>.env</em> file in the project root. You can either copy <em>.env.example</em> to <em>.env</em> and make edits or create the file from scratch then add the environment variables. Use nano to edit/create the file: <code>sudo nano .env</code>. My <em>.env</em> own file is shown in a screenshot below. I used a managed database service for both PostgreSQL (<a href="https://www.elephantsql.com/">ElephantSQL</a>) and Redis (<a href="https://redislabs.com/">Redis Labs</a>). Make the <code>INSTANCE_ID</code> environment variable unique for each droplet.</li>
<li>Install Docker and Docker Compose (<a href="https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-install-and-use-docker-on-ubuntu-16-04</a>, <a href="https://www.digitalocean.com/community/tutorials/how-to-install-docker-compose-on-ubuntu-16-04">https://www.digitalocean.com/community/tutorials/how-to-install-docker-compose-on-ubuntu-16-04</a>). You can test your installations by running <code>docker --version</code> and <code>docker-compose --version</code>. Ensure the docker service is running: <code>sudo systemctl status docker</code>.</li>
<li>Build and run the <em>hits</em> application: <code>docker-compose -f docker-compose.prod.yml up --build -d</code> (you should be in the root directory of the project (/www/var/hits). Now when you visit, your dropletâ€™s IP address, you should be greeted by the <em>hits</em> app.</li>
</ul>

<p><img src="https://cdn-images-1.medium.com/max/800/1*q_W-QTcla8D4ecyplNtvDw.jpeg" alt="" /></p>

<p>The hits appÂ ðŸ™Œ</p>

<p><img src="https://cdn-images-1.medium.com/max/1000/1*ci5wRdiGkabNsPyY2xIdaA.png" alt="" /></p>

<p>MyÂ .env file for hits app in production (if youâ€™re reading this, the postgres and redis dbs have already been destroyed ðŸ‘€)</p>

<h2 id="load-balancer">Load balancer</h2>

<p>Once all your servers are up and running, create a new load balancer.</p>

<p><img src="https://cdn-images-1.medium.com/max/1000/1*a7406vz2Slq4q19LaRHfHA.jpeg" alt="" /></p>

<p><img src="https://cdn-images-1.medium.com/max/800/1*-KS7Q9NK4S9-FCZP3i5BVQ.jpeg" alt="" /></p>

<p>Once your load balancer is up, add your droplets to it.</p>

<p><img src="https://cdn-images-1.medium.com/max/800/1*O4PcqIRqWw03v_-Swbc7VQ.jpeg" alt="" /></p>

<p>Now you can visit your load balancerâ€™s IP address. The APP INSTANCE shows what instance of the application (droplet) a request was routed to.</p>

<p>Letâ€™s go into the settings of the load balancer for a bitâ€¦</p>

<p><img src="https://cdn-images-1.medium.com/max/800/1*aIdtTYKJAU6ouagaw7GS-Q.jpeg" alt="" /></p>

<p>Load balancerÂ settings</p>

<p>So DigitalOcean gives us options to customize our load balancer.</p>

<p>We can choose an algorithm for the load balancer to use to route traffic to the droplets. Thereâ€™s <em>Round Robin</em> and <em>Least Connections</em>. In Round Robin, the requests are routed in a circular order from one droplet to the next. On the other hand, Least Connections routes to the server with the least traffic.</p>

<p>Thereâ€™s also health checks. You can set an endpoint e.g your appâ€™s home page (<a href="http://0.0.0.0:80">http://0.0.0.0:80</a>) for the load balancer to test and see if the server is running. If the server crashes or is offline, the load balancer would know and not send traffic to the server until itâ€™s back up.</p>

<p>With Sticky sessions, you can glue a user to a particular server. If enabled, after a userâ€™s first request, follow up requests would be routed to the same server.</p>

</article>

<a href="http://bit.ly/nksnewsletter" target="_blank">Subscribe to my newsletter</a> for updates on new articles, courses and more. Also, consider supporting <a href="https://www.patreon.com/user?u=16416296" target="_blank">Alpha Coder on Patreon</a>.


  <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "alphacoderxyz" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>



    </div>
<div class="footer">
    
    
    <div class="footer-links">
        <a href="http://twitter.com/nicholaskajoh">Twitter</a>
        <a href="https://github.com/nicholaskajoh">GitHub</a>
        <a href="https://www.patreon.com/user?u=16416296">Patreon</a>
        <a href="/post/index.xml">RSS</a>
    </div>
    

    
    
    <div class="copyright">Â© [ This Year ] Nicholas Kajoh</div>
    
</div>
</body>

</html>